<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ForeFlight Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .error-entry {
            background-color: #fff3f3;
            border-left: 4px solid #dc3545;
            animation: highlight-error 2s ease-in-out;
        }
        @keyframes highlight-error {
            0% { background-color: #ffebeb; }
            50% { background-color: #ffe0e0; }
            100% { background-color: #fff3f3; }
        }
        .validation-error {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 0.5em;
        }
        .flight-entry {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .flight-entry.has-error {
            background-color: #fff3f3;  /* Light red for invalid entries */
        }
        .flight-entry.pic-flight {
            background-color: #e8f5e9;  /* Light green for PIC flights */
        }
        .flight-entry.dual-only {
            background-color: #fff9c4;  /* Light yellow for dual-only flights */
        }
        .flight-entry.night-only {
            background-color: #e3f2fd;  /* Light blue for night-only flights */
        }
        .flight-entry.split-role {
            background-color: #f3e5f5;  /* Light purple for SPLIT role flights */
        }
        .flight-entry.cross-country {
            background-color: #fff3e0;  /* Light orange for cross-country flights */
        }
        .flight-header {
            font-weight: 500;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.95em;
        }
        .flight-date {
            font-size: 1.1em;
            font-weight: bold;
            color: #8B0000;
        }
        .flight-stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 0;  /* Allow text truncation */
        }
        .stat-label {
            font-size: 0.7em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.25px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stat-value {
            font-weight: 500;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .validation-error {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #dee2e6;
        }
        .running-totals {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #dee2e6;
        }
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stats-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        .nav-controls {
            position: sticky;
            top: 0;
            background: white;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .current-error {
            background-color: #ffeeba !important;
            border-left: 4px solid #ffc107 !important;
        }
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .total-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .total-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 0.2rem;
        }
        .total-value {
            font-weight: 500;
            color: #0d6efd;
        }
        .validation-stats {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;  /* Set a fixed height for the chart */
            margin-bottom: 2rem;
        }
        .aircraft-stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .aircraft-stat-card {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-header {
            font-weight: 500;
            color: #0d6efd;
            margin: 0;
        }
        .stat-details {
            font-size: 0.9em;
            color: #6c757d;
            text-align: right;
        }
        .aircraft-stats-table {
            width: 100%;
            margin-bottom: 1rem;
            background-color: #fff;
            border-collapse: collapse;
        }
        .aircraft-stats-table th,
        .aircraft-stats-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }
        .aircraft-stats-table th {
            background-color: #f8f9fa;
            font-weight: 500;
            cursor: pointer;
        }
        .aircraft-stats-table th:hover {
            background-color: #e9ecef;
        }
        .aircraft-stats-table tr:last-child td {
            border-bottom: none;
        }
        .sort-icon::after {
            content: '↕';
            margin-left: 0.5rem;
            color: #6c757d;
        }
        .sort-asc::after {
            content: '↑';
            color: #0d6efd;
        }
        .sort-desc::after {
            content: '↓';
            color: #0d6efd;
        }
        .upload-form {
            position: relative;
            z-index: 2;
        }
        .split-role-text {
            color: #9c27b0;  /* Purple text color for SPLIT role */
            font-weight: bold;
        }
        .flight-table {
            width: 100%;
            margin-bottom: 1rem;
            background-color: #fff;
            border-collapse: collapse;
        }
        .flight-table th,
        .flight-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
            font-size: 0.9em;
            vertical-align: middle;
        }
        .flight-table th {
            background-color: #f8f9fa;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .flight-table tr:hover td {
            color: #ff0000 !important;
            transition: color 0.2s ease-in-out;
        }
        .flight-table tr:hover td.running-total {
            color: #ff0000 !important;
        }
        .flight-table tr:hover {
            background-color: inherit !important;
        }
        .flight-table tr:hover .badge {
            color: #ff0000 !important;
        }
        .flight-table tr:hover .disclosure-triangle {
            color: #ff0000 !important;
        }
        .flight-table > tbody > tr.has-error {
            background-color: #fff3f3 !important;  /* Light red for invalid entries */
        }
        .flight-table > tbody > tr.pic-flight {
            background-color: #e8f5e9 !important;  /* Light green for PIC flights */
        }
        .flight-table > tbody > tr.dual-only {
            background-color: #fff9c4 !important;  /* Light yellow for dual-only flights */
        }
        .flight-table > tbody > tr.night-only {
            background-color: #e3f2fd !important;  /* Light blue for night-only flights */
        }
        .flight-table > tbody > tr.split-role {
            background-color: #f3e5f5 !important;  /* Light purple for SPLIT role flights */
        }
        .flight-table > tbody > tr.cross-country {
            background-color: #fff3e0 !important;  /* Light orange for cross-country flights */
        }
        .flight-date {
            color: #8B0000;
            font-weight: 500;
            white-space: nowrap;
        }
        .route {
            white-space: nowrap;
        }
        .validation-error {
            color: #dc3545;
            font-size: 0.85em;
        }
        .running-totals {
            font-size: 0.85em;
            color: #6c757d;
        }
        .badge {
            font-size: 0.75em;
        }
        .badge-xc {
            background-color: #17a2b8;
            margin-left: 0.25rem;
        }
        .badge-xc i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }
        .badge-night {
            background-color: #6f42c1;
            margin-left: 0.25rem;
        }
        .badge-night i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }
        .badge-solo {
            background-color: #198754;
            margin-left: 0.25rem;
        }
        
        .badge-solo i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }

        .badge-dual {
            background-color: #fd7e14;
            margin-left: 0.25rem;
        }
        
        .badge-dual i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }
        .running-total {
            font-family: monospace;
            background-color: #f8f9fa;
            font-weight: 500;
            color: #0d6efd;
        }
        .flight-table td.running-total {
            border-left: 1px solid #dee2e6;
        }
        .flight-table th.running-total {
            border-left: 1px solid #dee2e6;
            background-color: #e9ecef;
        }
        /* Add new styles for disclosure triangles */
        .disclosure-triangle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .disclosure-triangle.open {
            transform: rotate(90deg);
        }
        
        .d-none {
            display: none !important;
        }
        
        /* Search highlight styles */
        .search-highlight {
            background-color: #fff3cd;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .details-row {
            display: none;
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            margin: 0.25rem 0;
            font-family: monospace;
        }
        
        .details-row.show {
            display: block;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .detail-label {
            font-size: 0.75em;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.25rem;
        }

        .detail-value {
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: pre-line;
        }

        .detail-value br {
            content: "";
            margin: 0.15em;
            display: block;
        }

        /* Remove any hover effects that might interfere with the background colors */
        .flight-table > tbody > tr:hover {
            background-color: inherit !important;
        }

        /* Ensure details rows don't get colored */
        .flight-table > tbody > tr.details-row {
            background-color: #f8f9fa !important;
        }

        .flight-table-container {
            position: relative;
            max-height: 70vh;  /* Limit height to 70% of viewport height */
            overflow: hidden;
        }

        .flight-table-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .flight-table-body {
            overflow-y: auto;
            max-height: calc(70vh - 50px);  /* Subtract header height */
        }

        .flight-table th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        /* Add examiner summary styles */
        .examiner-category {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .examiner-category h6 {
            color: #0d6efd;
            margin-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        
        .examiner-category h6 i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        .examiner-categories {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .examiner-category .table {
            margin-bottom: 0;
            font-size: 0.9em;
        }
        
        .examiner-category .table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        .examiner-category .table td {
            vertical-align: middle;
        }
        
        #examiner-summary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .examiner-category .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Add styles for expanded tables */
        .table-responsive.expanded,
        .flight-table-body.expanded {
            max-height: none !important;
            overflow: visible !important;
        }

        .flight-table-container.expanded {
            max-height: none !important;
        }

        /* Add styles for statistics tables */
        .table-sm th {
            background-color: #f8f9fa;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }
        
        .table-sm td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            font-family: monospace;
        }
        
        /* Checkbox animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 0.3s ease-in-out;
        }
        
        .filter-checkbox {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-checkbox:hover {
            transform: scale(1.1);
            font-size: 0.95em;
        }
        
        /* Filter indicator */
        .filter-indicator {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-size: 0.8rem;
        }
        
        .filter-indicator.active {
            opacity: 1;
            animation: pulse-green 0.5s ease-in-out;
        }
        
        @keyframes pulse-green {
            0% { transform: scale(1); background-color: #28a745; }
            50% { transform: scale(1.1); background-color: #218838; }
            100% { transform: scale(1); background-color: #28a745; }
        }
        
        .table-responsive {
            margin-bottom: 0;
        }
        
        .card-title {
            margin-bottom: 1rem;
            color: #0d6efd;
            font-weight: 500;
        }

        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }
        
        .table-responsive.expanded {
            max-height: none !important;
            overflow: visible;
        }
        
        .expand-tables-btn {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">ForeFlight Dashboard</h1>
        
        <!-- Upload Form -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Upload Logbook</h5>
                <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                    <div class="mb-3">
                        <input type="file" class="form-control" name="file" accept=".csv">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="studentPilotCheck" name="student_pilot">
                        <label class="form-check-label" for="studentPilotCheck">
                            I am a student pilot
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload and Validate</button>
                </form>
            </div>
        </div>

        <!-- Quick Navigation -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Quick Navigation</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('aircraft-stats').scrollIntoView({behavior: 'smooth'})">
                        <i class="fas fa-plane"></i> Aircraft Statistics
                    </button>
                    <button class="btn btn-outline-success" id="toggleTables">
                        <i class="fas fa-expand"></i> <span>Expand Tables</span>
                    </button>
                    <button class="btn btn-outline-warning" id="verifyPICButton" style="display: none;" onclick="verifyPICEndorsements()">
                        <i class="fas fa-check-circle"></i> Verify PIC Endorsements
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructor Endorsements -->
        {% if is_student_pilot %}
        <div class="card mb-4" id="endorsementsSection" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">
                    <span class="disclosure-triangle" data-target="endorsements-table">▶</span>
                    Instructor Endorsements
                </h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <form action="{{ url_for('add_endorsement_route') }}" method="post" class="d-flex gap-2">
                            <input type="date" class="form-control" name="start_date" required>
                            <button type="submit" class="btn btn-primary">Add Endorsement</button>
                        </form>
                    </div>
                </div>
                <div id="endorsements-table" class="details-row">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Start Date</th>
                                    <th>Expiration Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if endorsements %}
                                {% for endorsement in endorsements %}
                                <tr>
                                    <td>{{ endorsement.start_date.split('T')[0] }}</td>
                                    <td>{{ endorsement.expiration_date.split('T')[0] }}</td>
                                    <td>
                                        {% if endorsement.expiration_date >= now %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-danger">Expired</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form action="{{ url_for('delete_endorsement_route', endorsement_id=endorsement.id) }}" method="post" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No endorsements found</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if stats %}
        <!-- Combined Flight Statistics -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Flight Statistics</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th class="text-start">Time Period</th>
                                <th>Ground Training</th>
                                <th>ASEL Time</th>
                                <th>Cross Country</th>
                                <th>Day</th>
                                <th>Night</th>
                                <th>Sim Instrument</th>
                                <th>Dual Received</th>
                                <th>PIC Time</th>
                                <th>Takeoffs/Landings</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-info">
                                <td class="fw-bold text-start">Recent (2 Months)</td>
                                <td>{{ "%.1f"|format(recent_experience.total_ground_training) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_time_asel) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_cross_country) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_day) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_night) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_sim_instrument) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_dual_received) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_pic) }}</td>
                                <td>{{ recent_experience.total_takeoffs }}/{{ recent_experience.total_landings }}</td>
                            </tr>
                            <tr class="table-warning">
                                <td class="fw-bold text-start">Last Year</td>
                                <td>{{ "%.1f"|format(stats.total_ground_training) }}</td>
                                <td>{{ "%.1f"|format(stats.total_time_asel) }}</td>
                                <td>{{ "%.1f"|format(stats.total_cross_country) }}</td>
                                <td>{{ "%.1f"|format(stats.total_day) }}</td>
                                <td>{{ "%.1f"|format(stats.total_night) }}</td>
                                <td>{{ "%.1f"|format(stats.total_sim_instrument) }}</td>
                                <td>{{ "%.1f"|format(stats.total_dual_received) }}</td>
                                <td>{{ "%.1f"|format(stats.total_pic) }}</td>
                                <td>{{ stats.total_takeoffs }}/{{ stats.total_landings }}</td>
                            </tr>
                            <tr class="table-success">
                                <td class="fw-bold text-start">All Time</td>
                                <td>{{ "%.1f"|format(all_time.total_ground_training) }}</td>
                                <td>{{ "%.1f"|format(all_time.total_time_asel) }}</td>
                                <td>{{ "%.1f"|format(all_time.total_cross_country) }}</td>
                                <td>{{ "%.1f"|format(all_time.total_day) }}</td>
                                <td>{{ "%.1f"|format(all_time.total_night) }}</td>
                                <td>{{ "%.1f"|format(all_time.total_sim_instrument) }}</td>
                                <td>{{ "%.1f"|format(all_time.total_dual_received) }}</td>
                                <td>{{ "%.1f"|format(all_time.total_pic) }}</td>
                                <td>{{ all_time.total_takeoffs }}/{{ all_time.total_landings }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Additional statistics toggle button -->
                <button class="btn btn-sm btn-outline-secondary mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#additionalStats" aria-expanded="false" aria-controls="additionalStats">
                    <i class="fas fa-chart-bar"></i> Show Additional Statistics
                </button>
                
                <!-- Collapsible additional statistics -->
                <div class="collapse mt-3" id="additionalStats">
                    <div class="card card-body bg-light">
                        <h6 class="card-subtitle mb-2 text-muted">Aircraft Type Breakdown</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Tailwheel Time:</strong> 
                                    <span class="badge bg-secondary">Recent: {{ "%.1f"|format(recent_experience.total_time_tailwheel) }}</span>
                                    <span class="badge bg-warning text-dark">Year: {{ "%.1f"|format(stats.total_time_tailwheel) }}</span>
                                    <span class="badge bg-success">All: {{ "%.1f"|format(all_time.total_time_tailwheel) }}</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Nosewheel Time:</strong> 
                                    <span class="badge bg-secondary">Recent: {{ "%.1f"|format(recent_experience.total_time_tricycle) }}</span>
                                    <span class="badge bg-warning text-dark">Year: {{ "%.1f"|format(stats.total_time_tricycle) }}</span>
                                    <span class="badge bg-success">All: {{ "%.1f"|format(all_time.total_time_tricycle) }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Combined Error Navigation and Validation Summary -->
        <div class="nav-controls">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                {% set error_count = entries|selectattr('error_explanation')|list|length if entries else 0 %}
                {% if error_count > 0 %}
                <button class="btn btn-outline-primary" onclick="navigateError(-1)">← Previous Error</button>
                {% endif %}
                <div class="validation-stats">
                    <span class="badge bg-secondary me-2">Total Entries: {% if entries %}{{ entries|length }}{% else %}0{% endif %}</span>
                    <span class="badge {% if error_count > 0 %}bg-danger{% else %}bg-success{% endif %}">
                        Issues: {{ error_count }}
                    </span>
                    {% if entries %}
                    {% set pic_solo_flights = entries|selectattr('pic_time', '>', 0)|list %}
                    <span class="badge bg-info ms-2">
                        PIC/Solo Flights: {{ pic_solo_flights|length }}
                    </span>
                    {% endif %}
                </div>
                {% if error_count > 0 %}
                <span id="errorCounter" class="text-muted"></span>
                <button class="btn btn-outline-primary" onclick="navigateError(1)">Next Error →</button>
                {% endif %}
            </div>
        </div>

        <!-- Endorsement Validation Summary -->
        {% if entries %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Endorsement Validation Summary</h5>
                <div class="d-flex gap-3 flex-wrap">
                    <div class="validation-stats">
                        {% set pic_solo_flights = entries|selectattr('pic_time', '>', 0)|list %}
                        <span class="badge bg-primary me-2">Total PIC/Solo Flights: {{ pic_solo_flights|length }}</span>
                        <span id="validEndorsementCount" class="badge bg-success me-2">Valid Endorsements: --</span>
                        <span id="invalidEndorsementCount" class="badge bg-danger">Missing Endorsements: --</span>
                    </div>
                    <button class="btn-sm btn-outline-primary" onclick="verifyPICEndorsements()">
                        <i class="fas fa-sync-alt"></i> Refresh Validation
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Flight Entries Table -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Flight Entries</h5>
                
                <!-- Search and Filter Controls -->
                <div class="row mb-3">
                    <div class="col-md-6 mb-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="flight-search" placeholder="Search flights..." aria-label="Search flights">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-wrap align-items-center" id="flight-type-filter">
                            <span id="filter-indicator" class="badge bg-success me-2 filter-indicator">Filtering...</span>
                            <label class="form-label fw-bold me-3 pt-1">Filter by Type:</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input filter-checkbox" type="checkbox" id="filter-all" checked onclick="handleFilterClick(this)">
                                <label class="form-check-label" for="filter-all">All</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input filter-checkbox" type="checkbox" id="filter-pic" onclick="handleFilterClick(this)">
                                <label class="form-check-label" for="filter-pic">PIC</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input filter-checkbox" type="checkbox" id="filter-dual" onclick="handleFilterClick(this)">
                                <label class="form-check-label" for="filter-dual">Dual</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input filter-checkbox" type="checkbox" id="filter-solo" onclick="handleFilterClick(this)">
                                <label class="form-check-label" for="filter-solo">Solo</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input filter-checkbox" type="checkbox" id="filter-night" onclick="handleFilterClick(this)">
                                <label class="form-check-label" for="filter-night">Night</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input filter-checkbox" type="checkbox" id="filter-xc" onclick="handleFilterClick(this)">
                                <label class="form-check-label" for="filter-xc">Cross Country</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input filter-checkbox" type="checkbox" id="filter-instrument" onclick="handleFilterClick(this)">
                                <label class="form-check-label" for="filter-instrument">Instrument</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="flight-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Route</th>
                                <th>Aircraft</th>
                                <th>Total</th>
                                <th>Day/Night</th>
                                <th>Ldg</th>
                                <th>Role</th>
                                <th>PIC</th>
                                <th>Dual Rcvd</th>
                                <th>Status</th>
                                <th class="text-end running-total">Ground</th>
                                <th class="text-end running-total">ASEL</th>
                                <th class="text-end running-total">XC</th>
                                <th class="text-end running-total">Day</th>
                                <th class="text-end running-total">Night</th>
                                <th class="text-end running-total">Sim Inst</th>
                                <th class="text-end running-total">Dual Rcvd</th>
                                <th class="text-end running-total">PIC</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if entries %}
                            {% for entry in entries %}
                            <tr id="entry-{{ loop.index }}" 
                                class="{% if entry.error_explanation %}has-error{% endif %}
                                       {% if entry.pic_time > 0 and entry.dual_received == 0 %}pic-flight{% endif %}
                                       {% if entry.pic_time == 0 and entry.dual_received > 0 %}dual-only{% endif %}
                                       {% if entry.conditions.night > 0 and entry.conditions.day == 0 %}night-only{% endif %}
                                       {% if entry.pilot_role == 'SPLIT' %}split-role{% endif %}
                                       {% if entry.conditions.cross_country > 0 %}cross-country{% endif %}"
                                data-has-error="{{ 'true' if entry.error_explanation else 'false' }}">
                                <td class="flight-date">
                                    <span class="disclosure-triangle" data-target="flight-details-{{ loop.index }}">▶</span>
                                    {{ entry.date.split('T')[0] }}
                                </td>
                                <td class="route">{{ entry.departure.identifier if entry.departure else '---' }} → {{ entry.destination.identifier if entry.destination else '---' }}</td>
                                <td>{{ entry.aircraft.registration }}</td>
                                <td>{{ "%.1f"|format(entry.total_time) }}</td>
                                <td>{{ "%.1f"|format(entry.conditions.day) }}/{{ "%.1f"|format(entry.conditions.night) }}</td>
                                <td>{{ entry.landings_day + entry.landings_night }}</td>
                                <td class="{% if entry.pilot_role == 'SPLIT' %}split-role-text{% endif %}">{{ entry.pilot_role }}</td>
                                <td>{{ "%.1f"|format(entry.pic_time) }}</td>
                                <td>{{ "%.1f"|format(entry.dual_received) }}</td>
                                <td>
                                    {% if entry.error_explanation %}
                                    <span class="badge bg-danger" data-bs-toggle="tooltip" title="{{ entry.error_explanation }}">
                                        Invalid
                                    </span>
                                    {% else %}
                                    <span class="badge bg-success">Valid</span>
                                    {% endif %}
                                    {% if entry.conditions.cross_country > 0 %}
                                    <span class="badge badge-xc" data-bs-toggle="tooltip" title="Cross-country flight">
                                        <i class="fas fa-plane"></i> XC
                                    </span>
                                    {% endif %}
                                    {% if entry.conditions.night > 0 %}
                                    <span class="badge badge-night" data-bs-toggle="tooltip" title="Night flight">
                                        <i class="fas fa-moon"></i> Night
                                    </span>
                                    {% endif %}
                                    {% if entry.pic_time > 0 and entry.dual_received == 0 %}
                                    <span class="badge badge-solo" data-bs-toggle="tooltip" title="Solo flight">
                                        <i class="fas fa-user"></i> Solo
                                    </span>
                                    {% endif %}
                                    {% if entry.dual_received > 0 %}
                                    <span class="badge badge-dual" data-bs-toggle="tooltip" title="Dual instruction received">
                                        <i class="fas fa-users"></i> Dual
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.ground_training) if entry.running_totals.ground_training else "0.0" }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.asel_time) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.cross_country) if entry.running_totals.cross_country else "0.0" }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.day_time) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.night_time) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.sim_instrument) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.dual_received) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.pic_time) }}</td>
                                <td class="d-none solo-time">{{ entry.solo_time }}</td>
                                <td class="d-none xc-time">{{ entry.conditions.cross_country }}</td>
                                <td class="d-none instrument-time">{{ entry.conditions.simulated_instrument + entry.conditions.actual_instrument }}</td>
                            </tr>
                            <tr>
                                <td colspan="100%" class="details-row" id="flight-details-{{ loop.index }}">
                                    <div class="details-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Aircraft Details</span>
                                            <span class="detail-value">Registration: {{ entry.aircraft.registration }}
Type: {{ entry.aircraft.type }}
Category/Class: {{ entry.aircraft.category_class }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Route Information</span>
                                            <span class="detail-value">Departure: {{ entry.departure.identifier }}
Destination: {{ entry.destination.identifier }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Flight Times</span>
                                            <span class="detail-value">Total: {{ entry.total_time }}
Day: {{ entry.conditions.day }}
Night: {{ entry.conditions.night }}
PIC: {{ entry.pic_time }}
Dual Received: {{ entry.dual_received }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Landings</span>
                                            <span class="detail-value">Day: {{ entry.landings_day }}
Night: {{ entry.landings_night }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Running Totals</span>
                                            <span class="detail-value">Ground: {{ entry.running_totals.ground_training if entry.running_totals.ground_training else "0.0" }}
ASEL: {{ entry.running_totals.asel_time }}
Cross Country: {{ entry.running_totals.cross_country if entry.running_totals.cross_country else "0.0" }}
Day: {{ entry.running_totals.day_time }}
Night: {{ entry.running_totals.night_time }}
Sim Instrument: {{ entry.running_totals.sim_instrument }}
Dual Received: {{ entry.running_totals.dual_received }}
PIC: {{ entry.running_totals.pic_time }}</span>
                                        </div>
                                        {% if entry.remarks %}
                                        <div class="detail-item">
                                            <span class="detail-label">Remarks</span>
                                            <span class="detail-value">{{ entry.remarks }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="18" class="text-center p-5">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle"></i>
                                        Upload a ForeFlight logbook CSV file to view your flight data
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if aircraft_stats %}
        <!-- Aircraft Statistics -->
        <div id="aircraft-stats" class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Aircraft Statistics</h5>
                
                <!-- Bar Chart -->
                <div class="chart-container mb-4">
                    <canvas id="aircraftChart"></canvas>
                </div>

                {% if aircraft_stats %}
                <script type="text/javascript">
                    // Define chart data in a separate script block to avoid template/JS conflicts
                    const aircraftChartData = {
                        labels: {{ aircraft_stats|map(attribute='registration')|list|tojson|safe }},
                        datasets: [
                            {
                                label: 'Solo Hours',
                                data: {{ aircraft_stats|map(attribute='solo_time')|list|tojson|safe }},
                                backgroundColor: 'rgba(40, 167, 69, 0.5)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Dual Hours',
                                data: {{ aircraft_stats|map(attribute='dual_time')|list|tojson|safe }},
                                backgroundColor: 'rgba(255, 193, 7, 0.5)',
                                borderColor: 'rgba(255, 193, 7, 1)',
                                borderWidth: 1
                            }
                        ]
                    };
                </script>
                {% endif %}
                
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Initialize aircraft chart if it exists
                        const chartCanvas = document.getElementById('aircraftChart');
                        if (chartCanvas && typeof aircraftChartData !== 'undefined') {
                            const ctx = chartCanvas.getContext('2d');
                            new Chart(ctx, {
                                type: 'bar',
                                data: aircraftChartData,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            stacked: true
                                        },
                                        y: {
                                            stacked: true,
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Hours'
                                            }
                                        }
                                    },
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Aircraft Usage Statistics'
                                        },
                                        tooltip: {
                                            callbacks: {
                                                afterTitle: function(context) {
                                                    const idx = context[0].dataIndex;
                                                    const total = aircraftChartData.datasets[0].data[idx] + aircraftChartData.datasets[1].data[idx];
                                                    return `Total: ${total.toFixed(1)} hours`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    // This function handles checkbox clicks and updates the table immediately
                    window.handleFilterClick = function(checkbox) {
                        const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
                        
                        // If 'All' is checked, uncheck other filters
                        if (checkbox.id === 'filter-all' && checkbox.checked) {
                            filterCheckboxes.forEach(cb => {
                                if (cb.id !== 'filter-all') cb.checked = false;
                            });
                        }
                        // If any other filter is checked, uncheck 'All'
                        else if (checkbox.id !== 'filter-all' && checkbox.checked) {
                            const allCheckbox = document.getElementById('filter-all');
                            if (allCheckbox) allCheckbox.checked = false;
                        }
                        
                        // If no filters are checked, check 'All'
                        let anyChecked = false;
                        filterCheckboxes.forEach(cb => {
                            if (cb.checked) anyChecked = true;
                        });
                        if (!anyChecked) {
                            const allCheckbox = document.getElementById('filter-all');
                            if (allCheckbox) allCheckbox.checked = true;
                        }
                        
                        // Apply filters immediately
                        filterAndSearchFlights();
                        
                        // Add visual feedback
                        checkbox.classList.add('pulse-animation');
                        setTimeout(() => {
                            checkbox.classList.remove('pulse-animation');
                        }, 300);
                    };
                </script>

                <div class="flight-table-container">
                    <div class="flight-table-header">
                    <table class="aircraft-stats-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)" class="sort-icon">Registration</th>
                                <th onclick="sortTable(1)" class="sort-icon">Type</th>
                                <th onclick="sortTable(2)" class="sort-icon">Flights</th>
                                <th onclick="sortTable(3)" class="sort-icon">Total Hours</th>
                                <th onclick="sortTable(4)" class="sort-icon">Solo Hours</th>
                                <th onclick="sortTable(5)" class="sort-icon">Dual Hours</th>
                                <th>Avg Time/Flight</th>
                            </tr>
                        </thead>
                    </table>
                
                    <div class="flight-table-body">
                        <table class="aircraft-stats-table">
                            <thead style="visibility: hidden; position: absolute;">
                                <tr>
                                    <th>Registration</th>
                                    <th>Type</th>
                                    <th>Flights</th>
                                    <th>Total Hours</th>
                                    <th>Solo Hours</th>
                                    <th>Dual Hours</th>
                                    <th>Avg Time/Flight</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aircraft in aircraft_stats %}
                                <tr>
                                    <td>
                                        <span class="disclosure-triangle" data-target="aircraft-details-{{ loop.index }}">▶</span>
                                        {{ aircraft.registration }}
                                    </td>
                                    <td>{{ aircraft.type }}</td>
                                    <td>{{ aircraft.count }}</td>
                                    <td>{{ "%.1f"|format(aircraft.total_time) }}</td>
                                    <td>{{ "%.1f"|format(aircraft.solo_time) }}</td>
                                    <td>{{ "%.1f"|format(aircraft.dual_time) }}</td>
                                    <td>{{ "%.1f"|format(aircraft.total_time / aircraft.count) }}</td>
                                </tr>
                                <tr>
                                    <td colspan="100%" class="details-row" id="aircraft-details-{{ loop.index }}">
                                        <div class="details-grid">
                                            <div class="detail-item">
                                                <span class="detail-label">Aircraft Information</span>
                                                <span class="detail-value">
                                                    Registration: {{ aircraft.registration }}<br>
                                                    Type: {{ aircraft.type }}<br>
                                                    Total Flights: {{ aircraft.count }}<br>
                                                    Total Time: {{ "%.1f"|format(aircraft.total_time) }}<br>
                                                    Solo Time: {{ "%.1f"|format(aircraft.solo_time) }}<br>
                                                    Dual Time: {{ "%.1f"|format(aircraft.dual_time) }}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Flight History</span>
                                                <span class="detail-value">
                                                    {% for entry in entries if entry.aircraft.registration == aircraft.registration %}
                                                    {{ entry.date.split('T')[0] }}: {{ entry.total_time }} hours ({% if entry.dual_received > 0 %}Dual{% else %}Solo{% endif %})<br>
                                                    {% endfor %}
                                                </span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Disclosure triangle handling
        document.addEventListener('DOMContentLoaded', function() {
            // Get all disclosure triangles
            const triangles = document.querySelectorAll('.disclosure-triangle');
            
            // Add click handler to each triangle
            triangles.forEach(triangle => {
                triangle.addEventListener('click', function() {
                    // Get the target element
            });

            // Error navigation
            const errorEntries = document.querySelectorAll('.has-error');
            let currentErrorIndex = 0;

            function updateErrorCounter() {
                const counter = document.getElementById('error-counter');
                if (counter) {
                    counter.textContent = `${currentErrorIndex + 1}/${errorEntries.length}`;
                }
            }

            function navigateError(direction) {
                if (errorEntries.length === 0) return;
                
                // Remove highlight from current error
                errorEntries[currentErrorIndex].classList.remove('current-error');
                
                // Update index
                currentErrorIndex = (currentErrorIndex + direction + errorEntries.length) % errorEntries.length;
                
                // Highlight new current error and scroll to it
                errorEntries[currentErrorIndex].classList.add('current-error');
                errorEntries[currentErrorIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                updateErrorCounter();
            }

            // Initialize error counter
            if (errorEntries.length > 0) {
                updateErrorCounter();
            }

            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') {
                    navigateError(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateError(1);
                }
            });

            // Function to toggle details
            function toggleDetails(triangle, detailsId) {
                const detailsElement = document.getElementById(detailsId);
                if (!detailsElement) return;
                
                if (detailsElement.style.display === 'block') {
                    detailsElement.style.display = 'none';
                    detailsElement.classList.remove('show');
                    triangle.textContent = '▶';
                } else {
                    detailsElement.style.display = 'block';
                    detailsElement.classList.add('show');
                    triangle.textContent = '▼';
                }
            }

            // Add click handlers to all disclosure triangles
            document.querySelectorAll('.disclosure-triangle').forEach(triangle => {
                triangle.addEventListener('click', function() {
                    const detailsId = this.getAttribute('data-target');
                    toggleDetails(this, detailsId);
                });
            });

            // Add click handlers to all flight rows
            document.querySelectorAll('.flight-table tbody tr:not(.details-row)').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Don't toggle if clicking on a link or checkbox
                    if (e.target.tagName === 'A' || e.target.tagName === 'INPUT') {
                        return;
                    }
                    
                    const rowId = this.id.split('-')[1];
                    const detailsRow = document.getElementById(`flight-details-${rowId}`);
                    const triangle = this.querySelector('.disclosure-triangle');
                    if (triangle && detailsRow) {
                        toggleDetails(triangle, detailsRow.id);
                    }
                });
            });

            // Table sorting
            function sortTable(columnIndex) {
                const table = document.querySelector('.flight-table');
                if (!table) return;
                
                const tbody = table.querySelector('tbody');
                if (!tbody) return;
                
                const rows = Array.from(tbody.querySelectorAll('tr:not(.details-row)'));
                if (rows.length === 0) return;
                
                // Get current sort direction
                const th = table.querySelectorAll('th')[columnIndex];
                if (!th) return;
                
                const currentDirection = th.getAttribute('data-sort') === 'asc' ? 'desc' : 'asc';
                
                // Update all headers
                table.querySelectorAll('th').forEach(header => {
                    header.removeAttribute('data-sort');
                    const indicator = header.querySelector('.sort-indicator');
                    if (indicator) indicator.remove();
                });
                
                // Set new sort direction and indicator
                th.setAttribute('data-sort', currentDirection);
                const indicator = document.createElement('span');
                indicator.className = 'sort-indicator ms-1';
                indicator.innerHTML = currentDirection === 'asc' ? '▲' : '▼';
                th.appendChild(indicator);
                
                // Sort rows
                rows.sort((a, b) => {
                    const aCells = a.querySelectorAll('td');
                    const bCells = b.querySelectorAll('td');
                    
                    if (columnIndex >= aCells.length || columnIndex >= bCells.length) return 0;
                    
                    const aValue = aCells[columnIndex].textContent.trim();
                    const bValue = bCells[columnIndex].textContent.trim();
                    
                    // Handle numeric values
                    if (!isNaN(parseFloat(aValue)) && !isNaN(parseFloat(bValue))) {
                        return currentDirection === 'asc' ? 
                            parseFloat(aValue) - parseFloat(bValue) : 
                            parseFloat(bValue) - parseFloat(aValue);
                    }
                    
                    // Handle dates (in format YYYY-MM-DD)
                    if (aValue.match(/^\d{4}-\d{2}-\d{2}$/) && bValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return currentDirection === 'asc' ? 
                            new Date(aValue) - new Date(bValue) : 
                            new Date(bValue) - new Date(aValue);
                    }
                    
                    // Handle strings
                    return currentDirection === 'asc' ? 
                        aValue.localeCompare(bValue) : 
                        bValue.localeCompare(aValue);
                });
                
                // Reorder rows in the DOM
                rows.forEach(row => {
                    const rowId = row.id.split('-')[1];
                    const detailsRow = document.getElementById(`flight-details-${rowId}`);
                    tbody.appendChild(row);
                    if (detailsRow) {
                        tbody.appendChild(detailsRow);
                    }
                });
            }

            // Add click handlers to table headers for sorting
            document.querySelectorAll('.flight-table th').forEach((th, index) => {
                th.addEventListener('click', function() {
                    sortTable(index);
                });
            });

            // Function to synchronize column widths
            function syncColumnWidths() {
                const headerCells = document.querySelectorAll('.flight-table thead th');
                const firstRowCells = document.querySelectorAll('.flight-table tbody tr:first-child td');
                
                if (headerCells.length === 0 || firstRowCells.length === 0) return;
                
                headerCells.forEach((cell, index) => {
                    if (index < firstRowCells.length) {
                        cell.style.width = firstRowCells[index].offsetWidth + 'px';
                    }
                });
            }
                
            // Sync widths initially and on window resize
            syncColumnWidths();
            window.addEventListener('resize', syncColumnWidths);

            // Toggle table expansion
            const toggleButton = document.getElementById('toggle-table-expansion');
            if (toggleButton) {
                function toggleTableExpansion() {
                    const table = document.querySelector('.flight-table');
                    if (!table) return;
                    
                    const isExpanded = table.classList.contains('expanded');
                    
                    if (isExpanded) {
                        table.classList.remove('expanded');
                        toggleButton.textContent = 'Show All Columns';
                        toggleButton.classList.remove('btn-secondary');
                        toggleButton.classList.add('btn-primary');
                    } else {
                        table.classList.add('expanded');
                        toggleButton.textContent = 'Show Fewer Columns';
                        toggleButton.classList.remove('btn-primary');
                        toggleButton.classList.add('btn-secondary');
                    }
                }

                toggleButton.addEventListener('click', toggleTableExpansion);
            }

            // Search and filter functionality - make it globally accessible
            window.filterAndSearchFlights = function() {
                const searchInput = document.getElementById('flight-search');
                const searchText = searchInput ? searchInput.value.toLowerCase() : '';
                
                const allCheckbox = document.getElementById('filter-all');
                const picCheckbox = document.getElementById('filter-pic');
                const dualCheckbox = document.getElementById('filter-dual');
                const soloCheckbox = document.getElementById('filter-solo');
                const nightCheckbox = document.getElementById('filter-night');
                const xcCheckbox = document.getElementById('filter-xc');
                const instrumentCheckbox = document.getElementById('filter-instrument');
                
                const allChecked = allCheckbox && allCheckbox.checked;
                const picChecked = picCheckbox && picCheckbox.checked;
                const dualChecked = dualCheckbox && dualCheckbox.checked;
                const soloChecked = soloCheckbox && soloCheckbox.checked;
                const nightChecked = nightCheckbox && nightCheckbox.checked;
                const xcChecked = xcCheckbox && xcCheckbox.checked;
                const instrumentChecked = instrumentCheckbox && instrumentCheckbox.checked;
                
                const rows = document.querySelectorAll('.flight-table tbody tr:not(.details-row)');
                
                rows.forEach(row => {
                    // Skip detail rows
                    if (row.classList.contains('details-row')) return;
                    
                    const rowId = row.id.split('-')[1];
                    const detailsRow = document.getElementById(`flight-details-${rowId}`);
                    let showRow = false;
                    
                    // If 'All' is checked, show all rows that match the search
                    if (allChecked) {
                        showRow = true;
                    } else {
                        // Check if row matches any of the selected filters
                        if (picChecked && row.classList.contains('pic-flight')) showRow = true;
                        if (dualChecked && row.classList.contains('dual-only')) showRow = true;
                        if (soloChecked && row.querySelector('.solo-time') && parseFloat(row.querySelector('.solo-time').textContent) > 0) showRow = true;
                        if (nightChecked && row.classList.contains('night-only')) showRow = true;
                        if (xcChecked && row.querySelector('.xc-time') && parseFloat(row.querySelector('.xc-time').textContent) > 0) showRow = true;
                        if (instrumentChecked && row.querySelector('.instrument-time') && parseFloat(row.querySelector('.instrument-time').textContent) > 0) showRow = true;
                    }
                    
                    // Apply search filter if there's search text
                    if (searchText && showRow) {
                        const rowText = row.textContent.toLowerCase();
                        const detailsText = detailsRow ? detailsRow.textContent.toLowerCase() : '';
                        showRow = (rowText.includes(searchText) || detailsText.includes(searchText));
                    }
                    
                    // Show/hide the row and its details
                    row.style.display = showRow ? '' : 'none';
                    if (detailsRow) {
                        detailsRow.style.display = (showRow && detailsRow.classList.contains('show')) ? '' : 'none';
                    }
                });
                
                // Add a visual indicator that filtering has occurred
                const filterIndicator = document.getElementById('filter-indicator');
                if (filterIndicator) {
                    filterIndicator.classList.add('active');
                    setTimeout(() => {
                        filterIndicator.classList.remove('active');
                    }, 500);
                }
            };
            
            // Make handleFilterClick a global function so it can be called from HTML onclick attributes
            window.handleFilterClick = function(checkbox) {
                const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
                
                // If 'All' is checked, uncheck other filters
                if (checkbox.id === 'filter-all' && checkbox.checked) {
                    filterCheckboxes.forEach(cb => {
                        if (cb.id !== 'filter-all') cb.checked = false;
                    });
                }
                // If any other filter is checked, uncheck 'All'
                else if (checkbox.id !== 'filter-all' && checkbox.checked) {
                    const allCheckbox = document.getElementById('filter-all');
                    if (allCheckbox) allCheckbox.checked = false;
                }
                
                // If no filters are checked, check 'All'
                let anyChecked = false;
                filterCheckboxes.forEach(cb => {
                    if (cb.checked) anyChecked = true;
                });
                if (!anyChecked) {
                    const allCheckbox = document.getElementById('filter-all');
                    if (allCheckbox) allCheckbox.checked = true;
                }
                
                // Apply filters immediately
                window.filterAndSearchFlights();
                
                // Add visual feedback
                checkbox.classList.add('pulse-animation');
                setTimeout(() => {
                    checkbox.classList.remove('pulse-animation');
                }, 300);
                
                // Log for debugging
                console.log('Filter clicked:', checkbox.id, 'is checked:', checkbox.checked);
                return true;
            };
            
            // Setup search filtering
            const searchInput = document.getElementById('flight-search');
            if (searchInput) {
                searchInput.addEventListener('input', filterAndSearchFlights);
            }
            
            // Initial filter
            filterAndSearchFlights();
        });
            
            // Function to update UI based on student pilot status
            function updateUIForStudentPilot(isStudentPilot) {
                endorsementsSection.style.display = isStudentPilot ? 'block' : 'none';
                verifyPICButton.style.display = isStudentPilot ? 'inline-block' : 'none';
            }
            
            // Set initial state
            updateUIForStudentPilot(studentPilotCheck.checked);
            
            // Add change event listener
            studentPilotCheck.addEventListener('change', function() {
                updateUIForStudentPilot(this.checked);
            });
        });

        // Flight type filter logic
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.flight-type-checkbox');
            const tableRows = document.querySelectorAll('.flight-table tbody tr');

            function filterRows() {
                // Get all checked types
                const checkedTypes = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                tableRows.forEach(row => {
                    // Only filter main entry rows (not details rows)
                    if (row.classList.contains('details-row')) return;
                    // If no type is checked, show all
                    if (checkedTypes.length === 0) {
                        row.style.display = '';
                        return;
                    }
                    // If row matches any of the selected filters
                    if (picChecked && row.classList.contains('pic-flight')) showRow = true;
                    if (dualChecked && row.classList.contains('dual-only')) showRow = true;
                    if (soloChecked && row.querySelector('.solo-time') && parseFloat(row.querySelector('.solo-time').textContent) > 0) showRow = true;
                    if (nightChecked && row.classList.contains('night-only')) showRow = true;
                    if (xcChecked && row.querySelector('.xc-time') && parseFloat(row.querySelector('.xc-time').textContent) > 0) showRow = true;
                    if (instrumentChecked && row.querySelector('.instrument-time') && parseFloat(row.querySelector('.instrument-time').textContent) > 0) showRow = true;
                }
                
                // Apply search filter if there's search text
                if (searchText) {
                    const rowText = row.textContent.toLowerCase();
                    const detailsText = detailsRow ? detailsRow.textContent.toLowerCase() : '';
                    showRow = showRow && (rowText.includes(searchText) || detailsText.includes(searchText));
                }
                
                // Show/hide the row and its details
                row.style.display = showRow ? '' : 'none';
                if (detailsRow) {
                    detailsRow.style.display = (showRow && detailsRow.classList.contains('show')) ? '' : 'none';
                }
            });
        }
        

        

    </script>
</body>
</html>