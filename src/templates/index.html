<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ForeFlight Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .error-entry {
            background-color: #fff3f3;
            border-left: 4px solid #dc3545;
            animation: highlight-error 2s ease-in-out;
        }
        @keyframes highlight-error {
            0% { background-color: #ffebeb; }
            50% { background-color: #ffe0e0; }
            100% { background-color: #fff3f3; }
        }
        .validation-error {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 0.5em;
        }
        .flight-entry {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .flight-entry.has-error {
            background-color: #fff3f3;  /* Light red for invalid entries */
        }
        .flight-entry.pic-flight {
            background-color: #e8f5e9;  /* Light green for PIC flights */
        }
        .flight-entry.dual-only {
            background-color: #fff9c4;  /* Light yellow for dual-only flights */
        }
        .flight-entry.night-only {
            background-color: #e3f2fd;  /* Light blue for night-only flights */
        }
        .flight-entry.split-role {
            background-color: #f3e5f5;  /* Light purple for SPLIT role flights */
        }
        .flight-entry.cross-country {
            background-color: #fff3e0;  /* Light orange for cross-country flights */
        }
        .flight-header {
            font-weight: 500;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.95em;
        }
        .flight-date {
            font-size: 1.1em;
            font-weight: bold;
            color: #8B0000;
        }
        .flight-stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 0;  /* Allow text truncation */
        }
        .stat-label {
            font-size: 0.7em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.25px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stat-value {
            font-weight: 500;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .validation-error {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #dee2e6;
        }
        .running-totals {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #dee2e6;
        }
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stats-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        .nav-controls {
            position: sticky;
            top: 0;
            background: white;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .current-error {
            background-color: #ffeeba !important;
            border-left: 4px solid #ffc107 !important;
        }
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .total-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .total-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 0.2rem;
        }
        .total-value {
            font-weight: 500;
            color: #0d6efd;
        }
        .validation-stats {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;  /* Set a fixed height for the chart */
            margin-bottom: 2rem;
        }
        .aircraft-stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .aircraft-stat-card {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-header {
            font-weight: 500;
            color: #0d6efd;
            margin: 0;
        }
        .stat-details {
            font-size: 0.9em;
            color: #6c757d;
            text-align: right;
        }
        .aircraft-stats-table {
            width: 100%;
            margin-bottom: 1rem;
            background-color: #fff;
            border-collapse: collapse;
        }
        .aircraft-stats-table th,
        .aircraft-stats-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }
        .aircraft-stats-table th {
            background-color: #f8f9fa;
            font-weight: 500;
            cursor: pointer;
        }
        .aircraft-stats-table th:hover {
            background-color: #e9ecef;
        }
        .aircraft-stats-table tr:last-child td {
            border-bottom: none;
        }
        .sort-icon::after {
            content: '↕';
            margin-left: 0.5rem;
            color: #6c757d;
        }
        .sort-asc::after {
            content: '↑';
            color: #0d6efd;
        }
        .sort-desc::after {
            content: '↓';
            color: #0d6efd;
        }
        .upload-form {
            position: relative;
            z-index: 2;
        }
        .split-role-text {
            color: #9c27b0;  /* Purple text color for SPLIT role */
            font-weight: bold;
        }
        .flight-table {
            width: 100%;
            margin-bottom: 1rem;
            background-color: #fff;
            border-collapse: collapse;
        }
        .flight-table th,
        .flight-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
            font-size: 0.9em;
            vertical-align: middle;
        }
        .flight-table th {
            background-color: #f8f9fa;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .flight-table tr:hover td {
            color: #ff0000 !important;
            transition: color 0.2s ease-in-out;
        }
        .flight-table tr:hover td.running-total {
            color: #ff0000 !important;
        }
        .flight-table tr:hover {
            background-color: inherit !important;
        }
        .flight-table tr:hover .badge {
            color: #ff0000 !important;
        }
        .flight-table tr:hover .disclosure-triangle {
            color: #ff0000 !important;
        }
        .flight-table > tbody > tr.has-error {
            background-color: #fff3f3 !important;  /* Light red for invalid entries */
        }
        .flight-table > tbody > tr.pic-flight {
            background-color: #e8f5e9 !important;  /* Light green for PIC flights */
        }
        .flight-table > tbody > tr.dual-only {
            background-color: #fff9c4 !important;  /* Light yellow for dual-only flights */
        }
        .flight-table > tbody > tr.night-only {
            background-color: #e3f2fd !important;  /* Light blue for night-only flights */
        }
        .flight-table > tbody > tr.split-role {
            background-color: #f3e5f5 !important;  /* Light purple for SPLIT role flights */
        }
        .flight-table > tbody > tr.cross-country {
            background-color: #fff3e0 !important;  /* Light orange for cross-country flights */
        }
        .flight-date {
            color: #8B0000;
            font-weight: 500;
            white-space: nowrap;
        }
        .route {
            white-space: nowrap;
        }
        .validation-error {
            color: #dc3545;
            font-size: 0.85em;
        }
        .running-totals {
            font-size: 0.85em;
            color: #6c757d;
        }
        .badge {
            font-size: 0.75em;
        }
        .badge-xc {
            background-color: #17a2b8;
            margin-left: 0.25rem;
        }
        .badge-xc i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }
        .badge-night {
            background-color: #6f42c1;
            margin-left: 0.25rem;
        }
        .badge-night i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }
        .badge-solo {
            background-color: #198754;
            margin-left: 0.25rem;
        }
        
        .badge-solo i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }

        .badge-dual {
            background-color: #fd7e14;
            margin-left: 0.25rem;
        }
        
        .badge-dual i {
            font-size: 0.8em;
            margin-right: 0.2em;
        }
        .running-total {
            font-family: monospace;
            background-color: #f8f9fa;
            font-weight: 500;
            color: #0d6efd;
        }
        .flight-table td.running-total {
            border-left: 1px solid #dee2e6;
        }
        .flight-table th.running-total {
            border-left: 1px solid #dee2e6;
            background-color: #e9ecef;
        }
        /* Add new styles for disclosure triangles */
        .disclosure-triangle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .disclosure-triangle.open {
            transform: rotate(90deg);
        }
        
        .details-row {
            display: none;
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            margin: 0.25rem 0;
            font-family: monospace;
        }
        
        .details-row.show {
            display: block;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .detail-label {
            font-size: 0.75em;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.25rem;
        }

        .detail-value {
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: pre-line;
        }

        .detail-value br {
            content: "";
            margin: 0.15em;
            display: block;
        }

        /* Remove any hover effects that might interfere with the background colors */
        .flight-table > tbody > tr:hover {
            background-color: inherit !important;
        }

        /* Ensure details rows don't get colored */
        .flight-table > tbody > tr.details-row {
            background-color: #f8f9fa !important;
        }

        .flight-table-container {
            position: relative;
            max-height: 70vh;  /* Limit height to 70% of viewport height */
            overflow: hidden;
        }

        .flight-table-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .flight-table-body {
            overflow-y: auto;
            max-height: calc(70vh - 50px);  /* Subtract header height */
        }

        .flight-table th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        /* Add examiner summary styles */
        .examiner-category {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .examiner-category h6 {
            color: #0d6efd;
            margin-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        
        .examiner-category h6 i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        .examiner-categories {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .examiner-category .table {
            margin-bottom: 0;
            font-size: 0.9em;
        }
        
        .examiner-category .table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        .examiner-category .table td {
            vertical-align: middle;
        }
        
        #examiner-summary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .examiner-category .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Add styles for expanded tables */
        .table-responsive.expanded,
        .flight-table-body.expanded {
            max-height: none !important;
            overflow: visible !important;
        }

        .flight-table-container.expanded {
            max-height: none !important;
        }

        /* Add styles for statistics tables */
        .table-sm th {
            background-color: #f8f9fa;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }
        
        .table-sm td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 0.95em;
        }
        
        .table-responsive {
            margin-bottom: 0;
        }
        
        .card-title {
            margin-bottom: 1rem;
            color: #0d6efd;
            font-weight: 500;
        }

        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }
        
        .table-responsive.expanded {
            max-height: none !important;
            overflow: visible;
        }
        
        .expand-tables-btn {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">ForeFlight Dashboard</h1>
        
        <!-- Upload Form -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Upload Logbook</h5>
                <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                    <div class="mb-3">
                        <input type="file" class="form-control" name="file" accept=".csv">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="studentPilotCheck" name="student_pilot">
                        <label class="form-check-label" for="studentPilotCheck">
                            I am a student pilot
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload and Validate</button>
                </form>
            </div>
        </div>

        <!-- Quick Navigation -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Quick Navigation</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('aircraft-stats').scrollIntoView({behavior: 'smooth'})">
                        <i class="fas fa-plane"></i> Aircraft Statistics
                    </button>
                    <button class="btn btn-outline-success" id="toggleTables">
                        <i class="fas fa-expand"></i> <span>Expand Tables</span>
                    </button>
                    <button class="btn btn-outline-warning" id="verifyPICButton" style="display: none;" onclick="verifyPICEndorsements()">
                        <i class="fas fa-check-circle"></i> Verify PIC Endorsements
                    </button>
                </div>
            </div>
        </div>

        <!-- Instructor Endorsements -->
        <div class="card mb-4" id="endorsementsSection" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">
                    <span class="disclosure-triangle" data-target="endorsements-table">▶</span>
                    Instructor Endorsements
                </h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <form action="{{ url_for('add_endorsement_route') }}" method="post" class="d-flex gap-2">
                            <input type="date" class="form-control" name="start_date" required>
                            <button type="submit" class="btn btn-primary">Add Endorsement</button>
                        </form>
                    </div>
                </div>
                <div id="endorsements-table" class="details-row">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Start Date</th>
                                    <th>Expiration Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if endorsements %}
                                {% for endorsement in endorsements %}
                                <tr>
                                    <td>{{ endorsement.start_date.split('T')[0] }}</td>
                                    <td>{{ endorsement.expiration_date.split('T')[0] }}</td>
                                    <td>
                                        {% if endorsement.expiration_date >= now %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-danger">Expired</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form action="{{ url_for('delete_endorsement_route', endorsement_id=endorsement.id) }}" method="post" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No endorsements found</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {% if stats %}
        <!-- Recent Experience (Last 2 Calendar Months) -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Recent Experience (Last 2 Calendar Months)</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Ground Training</th>
                                <th>ASEL Time</th>
                                <th>Cross Country</th>
                                <th>Day</th>
                                <th>Night</th>
                                <th>Sim Instrument</th>
                                <th>Dual Received</th>
                                <th>PIC Time</th>
                                <th>Takeoffs/Landings</th>
                                <th>Tailwheel/Nosewheel</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ "%.1f"|format(recent_experience.total_ground_training) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_time_asel) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_cross_country) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_day) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_night) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_sim_instrument) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_dual_received) }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_pic) }}</td>
                                <td>{{ recent_experience.total_takeoffs }}/{{ recent_experience.total_landings }}</td>
                                <td>{{ "%.1f"|format(recent_experience.total_time_tailwheel) }}/{{ "%.1f"|format(recent_experience.total_time_tricycle) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Last Year Statistics -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Last Year Statistics</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Ground Training</th>
                                <th>ASEL Time</th>
                                <th>Cross Country</th>
                                <th>Day</th>
                                <th>Night</th>
                                <th>Sim Instrument</th>
                                <th>Dual Received</th>
                                <th>PIC Time</th>
                                <th>Takeoffs/Landings</th>
                                <th>Tailwheel/Nosewheel</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ "%.1f"|format(stats.total_ground_training) }}</td>
                                <td>{{ "%.1f"|format(stats.total_time_asel) }}</td>
                                <td>{{ "%.1f"|format(stats.total_cross_country) }}</td>
                                <td>{{ "%.1f"|format(stats.total_day) }}</td>
                                <td>{{ "%.1f"|format(stats.total_night) }}</td>
                                <td>{{ "%.1f"|format(stats.total_sim_instrument) }}</td>
                                <td>{{ "%.1f"|format(stats.total_dual_received) }}</td>
                                <td>{{ "%.1f"|format(stats.total_pic) }}</td>
                                <td>{{ stats.total_takeoffs }}/{{ stats.total_landings }}</td>
                                <td>{{ "%.1f"|format(stats.total_time_tailwheel) }}/{{ "%.1f"|format(stats.total_time_tricycle) }}</td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
            </div>
        </div>

        <!-- All Time Statistics -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">All Time Statistics</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Ground Training</th>
                                <th>ASEL Time</th>
                                <th>Cross Country</th>
                                <th>Day</th>
                                <th>Night</th>
                                <th>Sim Instrument</th>
                                <th>Dual Received</th>
                                <th>PIC Time</th>
                                <th>Takeoffs/Landings</th>
                                <th>Tailwheel/Nosewheel</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ "%.1f"|format(all_time_stats.total_ground_training) }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_time_asel) }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_cross_country) }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_day) }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_night) }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_sim_instrument) }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_dual_received) }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_pic) }}</td>
                                <td>{{ all_time_stats.total_takeoffs }}/{{ all_time_stats.total_landings }}</td>
                                <td>{{ "%.1f"|format(all_time_stats.total_time_tailwheel) }}/{{ "%.1f"|format(all_time_stats.total_time_tricycle) }}</td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
            </div>
        </div>
        {% endif %}

        <!-- Combined Error Navigation and Validation Summary -->
        <div class="nav-controls">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                {% set error_count = entries|selectattr('error_explanation')|list|length if entries else 0 %}
                {% if error_count > 0 %}
                <button class="btn btn-outline-primary" onclick="navigateError(-1)">← Previous Error</button>
                {% endif %}
                <div class="validation-stats">
                    <span class="badge bg-secondary me-2">Total Entries: {% if entries %}{{ entries|length }}{% else %}0{% endif %}</span>
                    <span class="badge {% if error_count > 0 %}bg-danger{% else %}bg-success{% endif %}">
                        Issues: {{ error_count }}
                    </span>
                    {% if entries %}
                    {% set pic_solo_flights = entries|selectattr('pic_time', '>', 0)|list %}
                    <span class="badge bg-info ms-2">
                        PIC/Solo Flights: {{ pic_solo_flights|length }}
                    </span>
                    {% endif %}
                </div>
                {% if error_count > 0 %}
                <span id="errorCounter" class="text-muted"></span>
                <button class="btn btn-outline-primary" onclick="navigateError(1)">Next Error →</button>
                {% endif %}
            </div>
        </div>

        <!-- Endorsement Validation Summary -->
        {% if entries %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Endorsement Validation Summary</h5>
                <div class="d-flex gap-3 flex-wrap">
                    <div class="validation-stats">
                        {% set pic_solo_flights = entries|selectattr('pic_time', '>', 0)|list %}
                        <span class="badge bg-primary me-2">Total PIC/Solo Flights: {{ pic_solo_flights|length }}</span>
                        <span id="validEndorsementCount" class="badge bg-success me-2">Valid Endorsements: --</span>
                        <span id="invalidEndorsementCount" class="badge bg-danger">Missing Endorsements: --</span>
                    </div>
                    <button class="btn-sm btn-outline-primary" onclick="verifyPICEndorsements()">
                        <i class="fas fa-sync-alt"></i> Refresh Validation
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Examiner Summary Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <span class="disclosure-triangle" data-target="examiner-summary">▶</span>
                    DPE Review Summary
                </h5>
                <div id="examiner-summary" class="details-row">
                    <div class="examiner-categories">
                        {% if entries %}
                        <!-- PIC Cross Country Section -->
                        <div class="examiner-category mb-4">
                            <h6><i class="fas fa-route"></i> Total PIC Cross Country Time</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Route</th>
                                            <th>Aircraft</th>
                                            <th>XC Time</th>
                                            <th>Distance</th>
                                            <th>Running Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in entries if entry.conditions.cross_country > 0 and entry.pic_time > 0 %}
                                        <tr>
                                            <td>{{ entry.date.split('T')[0] }}</td>
                                            <td>{{ entry.departure.identifier }} → {{ entry.destination.identifier }}</td>
                                            <td>{{ entry.aircraft.registration }}</td>
                                            <td>{{ "%.1f"|format(entry.conditions.cross_country) }}</td>
                                            <td>{% if 'Distance:' in entry.remarks %}{{ entry.remarks.split('Distance: ')[1].split('nm')[0].strip() }} NM{% else %}{{ entry.remarks.split('Distance:')[1].split('nm')[0].strip() if 'Distance:' in entry.remarks else entry.remarks.split('Distance:')[1].split('NM')[0].strip() if 'Distance:' in entry.remarks else entry.remarks.split('Distance:')[1].split('nautical')[0].strip() if 'Distance:' in entry.remarks else '---' }}{% endif %}</td>
                                            <td>{{ "%.1f"|format(entry.running_totals.cross_country) }}</td>
                                            <td>
                                                <span class="badge badge-xc" data-bs-toggle="tooltip" title="Cross-country flight">
                                                    <i class="fas fa-plane"></i> XC
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- PIC Non-Cross Country Section -->
                        <div class="examiner-category mb-4">
                            <h6><i class="fas fa-plane"></i> Total PIC Non-Cross Country Time</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Route</th>
                                            <th>Aircraft</th>
                                            <th>Total Time</th>
                                            <th>Running Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in entries if entry.pic_time > 0 and entry.conditions.cross_country == 0 %}
                                        <tr>
                                            <td>{{ entry.date.split('T')[0] }}</td>
                                            <td>{{ entry.departure.identifier }} → {{ entry.destination.identifier }}</td>
                                            <td>{{ entry.aircraft.registration }}</td>
                                            <td>{{ "%.1f"|format(entry.pic_time) }}</td>
                                            <td>{{ "%.1f"|format(entry.running_totals.pic_time) }}</td>
                                            <td>
                                                <span class="badge badge-solo" data-bs-toggle="tooltip" title="PIC flight">
                                                    <i class="fas fa-user"></i> PIC
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Cross Country Solo Section -->
                        <div class="examiner-category mb-4">
                            <h6><i class="fas fa-route"></i> Cross Country Solo Flights</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Route</th>
                                            <th>Aircraft</th>
                                            <th>XC Time</th>
                                            <th>Distance</th>
                                            <th>Running Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in entries if entry.conditions.cross_country > 0 and entry.pic_time > 0 and entry.dual_received == 0 %}
                                        <tr>
                                            <td>{{ entry.date.split('T')[0] }}</td>
                                            <td>{{ entry.departure.identifier }} → {{ entry.destination.identifier }}</td>
                                            <td>{{ entry.aircraft.registration }}</td>
                                            <td>{{ "%.1f"|format(entry.conditions.cross_country) }}</td>
                                            <td>{% if 'Distance:' in entry.remarks %}{{ entry.remarks.split('Distance: ')[1].split('nm')[0].strip() }} NM{% else %}{{ entry.remarks.split('Distance:')[1].split('nm')[0].strip() if 'Distance:' in entry.remarks else entry.remarks.split('Distance:')[1].split('NM')[0].strip() if 'Distance:' in entry.remarks else entry.remarks.split('Distance:')[1].split('nautical')[0].strip() if 'Distance:' in entry.remarks else '---' }}{% endif %}</td>
                                            <td>{{ "%.1f"|format(entry.running_totals.cross_country) }}</td>
                                            <td>
                                                <span class="badge badge-xc" data-bs-toggle="tooltip" title="Cross-country flight">
                                                    <i class="fas fa-plane"></i> XC
                                                </span>
                                                <span class="badge badge-solo" data-bs-toggle="tooltip" title="Solo flight">
                                                    <i class="fas fa-user"></i> Solo
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Non-Cross Country Solo Section -->
                        <div class="examiner-category mb-4">
                            <h6><i class="fas fa-user"></i> Solo Flights (Non-Cross Country)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Route</th>
                                            <th>Aircraft</th>
                                            <th>Total Time</th>
                                            <th>Running Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in entries if entry.pic_time > 0 and entry.dual_received == 0 and entry.conditions.cross_country == 0 %}
                                        <tr>
                                            <td>{{ entry.date.split('T')[0] }}</td>
                                            <td>{{ entry.departure.identifier }} → {{ entry.destination.identifier }}</td>
                                            <td>{{ entry.aircraft.registration }}</td>
                                            <td>{{ "%.1f"|format(entry.total_time) }}</td>
                                            <td>{{ "%.1f"|format(entry.running_totals.pic_time) }}</td>
                                            <td>
                                                <span class="badge badge-solo" data-bs-toggle="tooltip" title="Solo flight">
                                                    <i class="fas fa-user"></i> Solo
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Night Dual Instruction Section -->
                        <div class="examiner-category mb-4">
                            <h6><i class="fas fa-moon"></i> Dual Instruction for Night</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Route</th>
                                            <th>Aircraft</th>
                                            <th>Night Time</th>
                                            <th>Night Landings</th>
                                            <th>Running Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in entries if entry.conditions.night > 0 and entry.dual_received > 0 %}
                                        <tr>
                                            <td>{{ entry.date.split('T')[0] }}</td>
                                            <td>{{ entry.departure.identifier }} → {{ entry.destination.identifier }}</td>
                                            <td>{{ entry.aircraft.registration }}</td>
                                            <td>{{ "%.1f"|format(entry.conditions.night) }}</td>
                                            <td>{{ entry.landings_night }}</td>
                                            <td>{{ "%.1f"|format(entry.running_totals.night_time) }}</td>
                                            <td>
                                                <span class="badge badge-night" data-bs-toggle="tooltip" title="Night flight">
                                                    <i class="fas fa-moon"></i> Night
                                                </span>
                                                <span class="badge badge-dual" data-bs-toggle="tooltip" title="Dual instruction received">
                                                    <i class="fas fa-users"></i> Dual
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Simulated Instrument Dual Section -->
                        <div class="examiner-category mb-4">
                            <h6><i class="fas fa-tachometer-alt"></i> Dual Instruction with Simulated Instrument Time</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Route</th>
                                            <th>Aircraft</th>
                                            <th>Simulated</th>
                                            <th>Running Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in entries if entry.conditions.simulated_instrument > 0 and entry.dual_received > 0 %}
                                        <tr>
                                            <td>{{ entry.date.split('T')[0] }}</td>
                                            <td>{{ entry.departure.identifier }} → {{ entry.destination.identifier }}</td>
                                            <td>{{ entry.aircraft.registration }}</td>
                                            <td>{{ "%.1f"|format(entry.conditions.simulated_instrument) }}</td>
                                            <td>{{ "%.1f"|format(entry.running_totals.sim_instrument) }}</td>
                                            <td>
                                                <span class="badge badge-dual" data-bs-toggle="tooltip" title="Dual instruction received">
                                                    <i class="fas fa-users"></i> Dual
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Upload a logbook to view DPE review summary
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Flight Entries Table -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Flight Entries</h5>
                <div class="table-responsive">
                    <table class="flight-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Route</th>
                                <th>Aircraft</th>
                                <th>Total</th>
                                <th>Day/Night</th>
                                <th>Ldg</th>
                                <th>Role</th>
                                <th>PIC</th>
                                <th>Dual Rcvd</th>
                                <th>Status</th>
                                <th class="text-end running-total">Ground</th>
                                <th class="text-end running-total">ASEL</th>
                                <th class="text-end running-total">XC</th>
                                <th class="text-end running-total">Day</th>
                                <th class="text-end running-total">Night</th>
                                <th class="text-end running-total">Sim Inst</th>
                                <th class="text-end running-total">Dual Rcvd</th>
                                <th class="text-end running-total">PIC</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if entries %}
                            {% for entry in entries %}
                            <tr id="entry-{{ loop.index }}" 
                                class="{% if entry.error_explanation %}has-error{% endif %}
                                       {% if entry.pic_time > 0 and entry.dual_received == 0 %}pic-flight{% endif %}
                                       {% if entry.pic_time == 0 and entry.dual_received > 0 %}dual-only{% endif %}
                                       {% if entry.conditions.night > 0 and entry.conditions.day == 0 %}night-only{% endif %}
                                       {% if entry.pilot_role == 'SPLIT' %}split-role{% endif %}
                                       {% if entry.conditions.cross_country > 0 %}cross-country{% endif %}"
                                data-has-error="{{ 'true' if entry.error_explanation else 'false' }}">
                                <td class="flight-date">
                                    <span class="disclosure-triangle" data-target="flight-details-{{ loop.index }}">▶</span>
                                    {{ entry.date.split('T')[0] }}
                                </td>
                                <td class="route">{{ entry.departure.identifier if entry.departure else '---' }} → {{ entry.destination.identifier if entry.destination else '---' }}</td>
                                <td>{{ entry.aircraft.registration }}</td>
                                <td>{{ "%.1f"|format(entry.total_time) }}</td>
                                <td>{{ "%.1f"|format(entry.conditions.day) }}/{{ "%.1f"|format(entry.conditions.night) }}</td>
                                <td>{{ entry.landings_day + entry.landings_night }}</td>
                                <td class="{% if entry.pilot_role == 'SPLIT' %}split-role-text{% endif %}">{{ entry.pilot_role }}</td>
                                <td>{{ "%.1f"|format(entry.pic_time) }}</td>
                                <td>{{ "%.1f"|format(entry.dual_received) }}</td>
                                <td>
                                    {% if entry.error_explanation %}
                                    <span class="badge bg-danger" data-bs-toggle="tooltip" title="{{ entry.error_explanation }}">
                                        Invalid
                                    </span>
                                    {% else %}
                                    <span class="badge bg-success">Valid</span>
                                    {% endif %}
                                    {% if entry.conditions.cross_country > 0 %}
                                    <span class="badge badge-xc" data-bs-toggle="tooltip" title="Cross-country flight">
                                        <i class="fas fa-plane"></i> XC
                                    </span>
                                    {% endif %}
                                    {% if entry.conditions.night > 0 %}
                                    <span class="badge badge-night" data-bs-toggle="tooltip" title="Night flight">
                                        <i class="fas fa-moon"></i> Night
                                    </span>
                                    {% endif %}
                                    {% if entry.pic_time > 0 and entry.dual_received == 0 %}
                                    <span class="badge badge-solo" data-bs-toggle="tooltip" title="Solo flight">
                                        <i class="fas fa-user"></i> Solo
                                    </span>
                                    {% endif %}
                                    {% if entry.dual_received > 0 %}
                                    <span class="badge badge-dual" data-bs-toggle="tooltip" title="Dual instruction received">
                                        <i class="fas fa-users"></i> Dual
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.ground_training) if entry.running_totals.ground_training else "0.0" }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.asel_time) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.cross_country) if entry.running_totals.cross_country else "0.0" }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.day_time) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.night_time) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.sim_instrument) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.dual_received) }}</td>
                                <td class="text-end running-total">{{ "%.1f"|format(entry.running_totals.pic_time) }}</td>
                            </tr>
                            <tr>
                                <td colspan="100%" class="details-row" id="flight-details-{{ loop.index }}">
                                    <div class="details-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Aircraft Details</span>
                                            <span class="detail-value">Registration: {{ entry.aircraft.registration }}
Type: {{ entry.aircraft.type }}
Category/Class: {{ entry.aircraft.category_class }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Route Information</span>
                                            <span class="detail-value">Departure: {{ entry.departure.identifier }}
Destination: {{ entry.destination.identifier }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Flight Times</span>
                                            <span class="detail-value">Total: {{ entry.total_time }}
Day: {{ entry.conditions.day }}
Night: {{ entry.conditions.night }}
PIC: {{ entry.pic_time }}
Dual Received: {{ entry.dual_received }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Landings</span>
                                            <span class="detail-value">Day: {{ entry.landings_day }}
Night: {{ entry.landings_night }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Running Totals</span>
                                            <span class="detail-value">Ground: {{ entry.running_totals.ground_training if entry.running_totals.ground_training else "0.0" }}
ASEL: {{ entry.running_totals.asel_time }}
Cross Country: {{ entry.running_totals.cross_country if entry.running_totals.cross_country else "0.0" }}
Day: {{ entry.running_totals.day_time }}
Night: {{ entry.running_totals.night_time }}
Sim Instrument: {{ entry.running_totals.sim_instrument }}
Dual Received: {{ entry.running_totals.dual_received }}
PIC: {{ entry.running_totals.pic_time }}</span>
                                        </div>
                                        {% if entry.remarks %}
                                        <div class="detail-item">
                                            <span class="detail-label">Remarks</span>
                                            <span class="detail-value">{{ entry.remarks }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="18" class="text-center p-5">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Upload a ForeFlight logbook CSV file to view your flight data
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if aircraft_stats %}
        <!-- Aircraft Statistics -->
        <div id="aircraft-stats" class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Aircraft Statistics</h5>
                
                <!-- Bar Chart -->
                <div class="chart-container mb-4">
                    <canvas id="aircraftChart"></canvas>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Initialize aircraft chart
                        const aircraftLabels = {{ aircraft_stats|map(attribute='registration')|list|tojson|safe }};
                        const soloHours = {{ aircraft_stats|map(attribute='solo_time')|list|tojson|safe }};
                        const dualHours = {{ aircraft_stats|map(attribute='dual_time')|list|tojson|safe }};
                        
                        const ctx = document.getElementById('aircraftChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: aircraftLabels,
                                datasets: [{
                                    label: 'Solo Hours',
                                    data: soloHours,
                                    backgroundColor: 'rgba(40, 167, 69, 0.5)',  // Green for solo
                                    borderColor: 'rgba(40, 167, 69, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Dual Hours',
                                    data: dualHours,
                                    backgroundColor: 'rgba(255, 193, 7, 0.5)',  // Yellow for dual
                                    borderColor: 'rgba(255, 193, 7, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        stacked: true
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Hours'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Aircraft Usage Statistics'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            afterTitle: function(context) {
                                                const idx = context[0].dataIndex;
                                                const total = soloHours[idx] + dualHours[idx];
                                                return `Total: ${total.toFixed(1)} hours`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    });
                </script>

                <div class="flight-table-container">
                    <div class="flight-table-header">
                    <table class="aircraft-stats-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)" class="sort-icon">Registration</th>
                                <th onclick="sortTable(1)" class="sort-icon">Type</th>
                                <th onclick="sortTable(2)" class="sort-icon">Flights</th>
                                <th onclick="sortTable(3)" class="sort-icon">Total Hours</th>
                                <th onclick="sortTable(4)" class="sort-icon">Solo Hours</th>
                                <th onclick="sortTable(5)" class="sort-icon">Dual Hours</th>
                                <th>Avg Time/Flight</th>
                            </tr>
                        </thead>
                    </table>
                
                    <div class="flight-table-body">
                        <table class="aircraft-stats-table">
                            <thead style="visibility: hidden; position: absolute;">
                                <tr>
                                    <th>Registration</th>
                                    <th>Type</th>
                                    <th>Flights</th>
                                    <th>Total Hours</th>
                                    <th>Solo Hours</th>
                                    <th>Dual Hours</th>
                                    <th>Avg Time/Flight</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aircraft in aircraft_stats %}
                                <tr>
                                    <td>
                                        <span class="disclosure-triangle" data-target="aircraft-details-{{ loop.index }}">▶</span>
                                        {{ aircraft.registration }}
                                    </td>
                                    <td>{{ aircraft.type }}</td>
                                    <td>{{ aircraft.count }}</td>
                                    <td>{{ "%.1f"|format(aircraft.total_time) }}</td>
                                    <td>{{ "%.1f"|format(aircraft.solo_time) }}</td>
                                    <td>{{ "%.1f"|format(aircraft.dual_time) }}</td>
                                    <td>{{ "%.1f"|format(aircraft.total_time / aircraft.count) }}</td>
                                </tr>
                                <tr>
                                    <td colspan="100%" class="details-row" id="aircraft-details-{{ loop.index }}">
                                        <div class="details-grid">
                                            <div class="detail-item">
                                                <span class="detail-label">Aircraft Information</span>
                                                <span class="detail-value">
                                                    Registration: {{ aircraft.registration }}<br>
                                                    Type: {{ aircraft.type }}<br>
                                                    Total Flights: {{ aircraft.count }}<br>
                                                    Total Time: {{ "%.1f"|format(aircraft.total_time) }}<br>
                                                    Solo Time: {{ "%.1f"|format(aircraft.solo_time) }}<br>
                                                    Dual Time: {{ "%.1f"|format(aircraft.dual_time) }}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Flight History</span>
                                                <span class="detail-value">
                                                    {% for entry in entries if entry.aircraft.registration == aircraft.registration %}
                                                    {{ entry.date.split('T')[0] }}: {{ entry.total_time }} hours ({% if entry.dual_received > 0 %}Dual{% else %}Solo{% endif %})<br>
                                                    {% endfor %}
                                                </span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Disclosure triangle handling
        document.addEventListener('DOMContentLoaded', function() {
            // Get all disclosure triangles
            const triangles = document.querySelectorAll('.disclosure-triangle');
            
            // Add click handler to each triangle
            triangles.forEach(triangle => {
                triangle.addEventListener('click', function() {
                    // Get the target element
                    const targetId = this.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    
                    // Toggle visibility
                    if (targetElement) {
                        const isVisible = targetElement.style.display !== 'none';
                        targetElement.style.display = isVisible ? 'none' : 'block';
                        this.textContent = isVisible ? '▶' : '▼';
                    }
                });
            });
            
            // Initially hide all detail rows
            document.querySelectorAll('.details-row').forEach(row => {
                row.style.display = 'none';
            });
        });

        // Error navigation
        let currentErrorIndex = -1;
        const errorEntries = Array.from(document.querySelectorAll('tr[data-has-error="true"]'));
        
        function updateErrorCounter() {
            const counter = document.getElementById('errorCounter');
            if (!counter) return;
            
            if (errorEntries.length > 0 && currentErrorIndex >= 0) {
                counter.textContent = `Error ${currentErrorIndex + 1} of ${errorEntries.length}`;
            } else {
                counter.textContent = `${errorEntries.length} Errors Found`;
            }
        }

        function navigateError(direction) {
            if (errorEntries.length === 0) return;

            if (currentErrorIndex >= 0) {
                errorEntries[currentErrorIndex].classList.remove('current-error');
            }

            currentErrorIndex += direction;
            if (currentErrorIndex >= errorEntries.length) currentErrorIndex = 0;
            if (currentErrorIndex < 0) currentErrorIndex = errorEntries.length - 1;

            const targetEntry = errorEntries[currentErrorIndex];
            targetEntry.classList.add('current-error');
            targetEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateErrorCounter();
        }

        // Initialize error counter
        if (errorEntries.length > 0) {
            updateErrorCounter();
        }

        // Table sorting
        function sortTable(columnIndex) {
            const table = document.querySelector('.aircraft-stats-table');
            const headers = table.querySelectorAll('th');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                header.classList.add('sort-icon');
            });
            
            const currentHeader = headers[columnIndex];
            const isAscending = !currentHeader.classList.contains('sort-asc');
            
            currentHeader.classList.remove('sort-icon');
            currentHeader.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
            
            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex].textContent;
                const cellB = rowB.cells[columnIndex].textContent;
                
                if (columnIndex >= 2) {
                    return isAscending ? 
                        parseFloat(cellA) - parseFloat(cellB) : 
                        parseFloat(cellB) - parseFloat(cellA);
                }
                
                return isAscending ? 
                    cellA.localeCompare(cellB) : 
                    cellB.localeCompare(cellA);
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                navigateError(-1);
            } else if (e.key === 'ArrowRight') {
                navigateError(1);
            }
        });

        // Add JavaScript for handling disclosure triangles
        document.addEventListener('DOMContentLoaded', function() {
            // Function to toggle details
            function toggleDetails(triangle, detailsId) {
                const details = document.getElementById(detailsId);
                if (details) {
                    triangle.classList.toggle('open');
                    details.classList.toggle('show');
                }
            }

            // Add click handlers to all disclosure triangles
            document.querySelectorAll('.disclosure-triangle').forEach(triangle => {
                triangle.addEventListener('click', function() {
                    const detailsId = this.getAttribute('data-target');
                    toggleDetails(this, detailsId);
                });
            });
        });

        // Add script to synchronize column widths between header and body tables
        document.addEventListener('DOMContentLoaded', function() {
            const headerTable = document.querySelector('.flight-table-header .flight-table');
            const bodyTable = document.querySelector('.flight-table-body .flight-table');
            
            // Function to synchronize column widths
            function syncColumnWidths() {
                const headerCells = headerTable.querySelectorAll('th');
                const bodyCells = bodyTable.querySelectorAll('tr:first-child td');
                
                headerCells.forEach((cell, index) => {
                    if (bodyCells[index]) {
                        const width = Math.max(cell.offsetWidth, bodyCells[index].offsetWidth);
                        cell.style.width = width + 'px';
                        bodyCells[index].style.width = width + 'px';
                    }
                });
            }
            
            // Sync widths initially and on window resize
            syncColumnWidths();
            window.addEventListener('resize', syncColumnWidths);
        });

        // Remove the generatePDF function and add table toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('toggleTables');
            const buttonText = toggleButton.querySelector('span');
            const buttonIcon = toggleButton.querySelector('i');
            let tablesExpanded = false;

            function toggleTableExpansion() {
                const tableContainers = document.querySelectorAll('.table-responsive, .flight-table-body, .flight-table-container');
                tablesExpanded = !tablesExpanded;

                tableContainers.forEach(container => {
                    if (tablesExpanded) {
                        container.classList.add('expanded');
                    } else {
                        container.classList.remove('expanded');
                    }
                });

                // Update button text and icon
                buttonText.textContent = tablesExpanded ? 'Collapse Tables' : 'Expand Tables';
                buttonIcon.className = tablesExpanded ? 'fas fa-compress' : 'fas fa-expand';
            }

            toggleButton.addEventListener('click', toggleTableExpansion);
        });

        function verifyPICEndorsements() {
            const entries = {{ entries|tojson|safe }};
            fetch('/verify-pic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ entries: entries }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Update validation counters
                const totalPicSolo = entries.filter(entry => entry.pic_time > 0).length;
                const invalidCount = data.unendorsed_flights.length;
                const validCount = totalPicSolo - invalidCount;
                
                document.getElementById('validEndorsementCount').textContent = `Valid Endorsements: ${validCount}`;
                document.getElementById('invalidEndorsementCount').textContent = `Missing Endorsements: ${invalidCount}`;
                
                let message = '';
                
                // Show endorsement gaps
                if (data.gaps && data.gaps.length > 0) {
                    message += 'Gaps in Endorsement Coverage:\n';
                    data.gaps.forEach(gap => {
                        const start = new Date(gap.start).toLocaleDateString();
                        const end = new Date(gap.end).toLocaleDateString();
                        message += `• ${start} to ${end}\n`;
                    });
                    message += '\n';
                } else {
                    message += 'No gaps in endorsement coverage.\n\n';
                }
                
                // Show unendorsed flights
                if (data.unendorsed_flights.length === 0) {
                    message += 'All PIC/Solo flights have valid endorsements!';
                } else {
                    message += `Found ${data.total_invalid} flights without valid endorsements:\n`;
                    data.unendorsed_flights.forEach(flight => {
                        const date = new Date(flight.date).toLocaleDateString();
                        message += `• ${date}: ${flight.route} (${flight.pic_time} hours) - ${flight.type.toUpperCase()}\n`;
                    });
                }
                
                // Create a modal to display the results
                const modalHtml = `
                    <div class="modal fade" id="endorsementCheckModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Endorsement Check Results</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <div class="d-flex gap-2 mb-3">
                                            <span class="badge bg-primary">Total PIC/Solo Flights: ${totalPicSolo}</span>
                                            <span class="badge bg-success">Valid Endorsements: ${validCount}</span>
                                            <span class="badge bg-danger">Missing Endorsements: ${invalidCount}</span>
                                        </div>
                                        <pre style="white-space: pre-wrap;">${message}</pre>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove any existing modal
                const existingModal = document.getElementById('endorsementCheckModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add the new modal to the document
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('endorsementCheckModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error verifying PIC endorsements');
            });
        }

        // Add this at the beginning of your script section
        document.addEventListener('DOMContentLoaded', function() {
            const studentPilotCheck = document.getElementById('studentPilotCheck');
            const endorsementsSection = document.getElementById('endorsementsSection');
            const verifyPICButton = document.getElementById('verifyPICButton');
            
            // Function to update UI based on student pilot status
            function updateUIForStudentPilot(isStudentPilot) {
                endorsementsSection.style.display = isStudentPilot ? 'block' : 'none';
                verifyPICButton.style.display = isStudentPilot ? 'inline-block' : 'none';
            }
            
            // Set initial state
            updateUIForStudentPilot(studentPilotCheck.checked);
            
            // Add change event listener
            studentPilotCheck.addEventListener('change', function() {
                updateUIForStudentPilot(this.checked);
            });
        });
    </script>
</body>
</html> 